import gzip
from app_logger import Logger, get_logger
logger: Logger = get_logger("opa.decision_log_api")

from flask import (
    Blueprint,
    request
)

bp = Blueprint("opa_decision", __name__, url_prefix="/opa/decision")


@bp.route("", methods=["POST"])
def create():
    body = gzip.decompress(request.data)
    logger.info(f"request: {body}")
    return "ok"


# 2024-05-29 23:08:22,779 - permitta.opa.decision_log_api - INFO - request: b'[{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"fdfa44f1-9b5a-4821-a519-ab1c1b3f60d5","path":"permitta/trino/allow","input":{"action":{"operation":"ExecuteQuery"},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.262431721Z","metrics":{"counter_server_query_cache_hit":0,"timer_rego_input_parse_ns":938875,"timer_rego_query_compile_ns":1322083,"timer_rego_query_eval_ns":1091250,"timer_rego_query_parse_ns":626208,"timer_server_handler_ns":4957708},"req_id":1}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"c9f69d75-69d0-4950-8280-606c80a4210a","path":"permitta/trino/allow","input":{"action":{"operation":"AccessCatalog","resource":{"catalog":{"name":"system"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.301954138Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":44417,"timer_rego_query_eval_ns":60792,"timer_server_handler_ns":154667},"req_id":2}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"81072d4d-4c9e-4a8f-a9a4-498d6b118f21","path":"permitta/trino/allow","input":{"action":{"operation":"SelectFromColumns","resource":{"table":{"catalogName":"system","columns":["table_schem","table_catalog"],"schemaName":"jdbc","tableName":"schemas"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.305524513Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":67292,"timer_rego_query_eval_ns":78250,"timer_server_handler_ns":190250},"req_id":3}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"f48e1088-7d5e-41fc-80b4-9a7466c9b4d9","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.353386888Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":30375,"timer_rego_query_eval_ns":53291,"timer_server_handler_ns":122000},"req_id":4}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"9f475099-d846-4bf4-a669-9aa84a90be96","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.397574929Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":34791,"timer_rego_query_eval_ns":89542,"timer_server_handler_ns":158250},"req_id":5}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"79deef9e-b3e9-4297-80f5-ef21bd998ac7","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"information_schema"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.401816763Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":60167,"timer_rego_query_eval_ns":68000,"timer_server_handler_ns":154250},"req_id":6}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"fc930ebf-ea33-47bc-ad66-c0337865e43f","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"default"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:42492","timestamp":"2024-05-29T13:02:45.402986013Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":23334,"timer_rego_query_eval_ns":123500,"timer_server_handler_ns":163875},"req_id":7}\n]'
# 127.0.0.1 - - [29/May/2024 23:08:22] "POST /opa/decision HTTP/1.1" 200 -
# 2024-05-29 23:08:22,788 - permitta.opa.decision_log_api - INFO - request: b'[{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"1239ef19-60c9-44e7-a0de-a50ea057afdb","path":"permitta/trino/allow","input":{"action":{"operation":"ExecuteQuery"},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.741981501Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":328250,"timer_rego_query_eval_ns":1057917,"timer_server_handler_ns":2573791},"req_id":8}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"4d910ff7-6fde-4ca5-8e68-24b2b61b982d","path":"permitta/trino/allow","input":{"action":{"operation":"AccessCatalog","resource":{"catalog":{"name":"system"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.755406293Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":29042,"timer_rego_query_eval_ns":61167,"timer_server_handler_ns":131708},"req_id":9}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"74b6ce79-81c6-4f77-b3b8-3b22b31ef775","path":"permitta/trino/allow","input":{"action":{"operation":"SelectFromColumns","resource":{"table":{"catalogName":"system","columns":["table_schem","table_catalog"],"schemaName":"jdbc","tableName":"schemas"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.758365126Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":25458,"timer_rego_query_eval_ns":35667,"timer_server_handler_ns":91750},"req_id":10}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"b4118f78-82c0-4adf-9e18-3d2eb9cba6b4","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.798943001Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":32292,"timer_rego_query_eval_ns":58125,"timer_server_handler_ns":139500},"req_id":11}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"6d9ea66a-b11c-4029-bc61-ec2641a74e82","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.822500584Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":31916,"timer_rego_query_eval_ns":45500,"timer_server_handler_ns":106333},"req_id":12}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"bf608691-c7fc-49b7-99ce-77b70ed5bad8","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"information_schema"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.823930709Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":25584,"timer_rego_query_eval_ns":28958,"timer_server_handler_ns":79792},"req_id":13}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"9587218f-d507-477a-8d29-5328bf67120e","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"default"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:38330","timestamp":"2024-05-29T13:04:50.824554209Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":26125,"timer_rego_query_eval_ns":48292,"timer_server_handler_ns":96750},"req_id":14}\n]'
# 127.0.0.1 - - [29/May/2024 23:08:22] "POST /opa/decision HTTP/1.1" 200 -
# 2024-05-29 23:08:22,806 - permitta.opa.decision_log_api - INFO - request: b'[{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"7d504786-f0c0-40c4-9ae6-260f828e7a4d","path":"permitta/trino/allow","input":{"action":{"operation":"ExecuteQuery"},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.77707246Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":3997458,"timer_rego_query_eval_ns":1954667,"timer_server_handler_ns":6927834},"req_id":15}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"69f0fb54-a314-4996-9b4a-81754574756b","path":"permitta/trino/allow","input":{"action":{"operation":"AccessCatalog","resource":{"catalog":{"name":"system"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.835693168Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":44625,"timer_rego_query_eval_ns":76292,"timer_server_handler_ns":176791},"req_id":16}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"2de43af7-fd54-466b-9393-eac97baea273","path":"permitta/trino/allow","input":{"action":{"operation":"SelectFromColumns","resource":{"table":{"catalogName":"system","columns":["table_schem","table_catalog"],"schemaName":"jdbc","tableName":"schemas"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.837556043Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":43084,"timer_rego_query_eval_ns":38042,"timer_server_handler_ns":132958},"req_id":17}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"1c46eeec-916a-4446-9c75-5d742034a3fb","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.902653502Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":35833,"timer_rego_query_eval_ns":63708,"timer_server_handler_ns":155334},"req_id":18}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"1cba1aa6-dcda-4c99-96ca-0f849e3998b4","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.941879335Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":56916,"timer_rego_query_eval_ns":66917,"timer_server_handler_ns":211250},"req_id":19}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"0252cd9f-5d28-40de-b266-4761d7ba92cd","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"information_schema"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.94342746Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":66833,"timer_rego_query_eval_ns":69541,"timer_server_handler_ns":161750},"req_id":20}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"131c170e-8492-417a-88aa-f7a67c55939b","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"default"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:07:52.944022835Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":13833,"timer_rego_query_eval_ns":25625,"timer_server_handler_ns":52291},"req_id":21}\n]'
# 127.0.0.1 - - [29/May/2024 23:08:22] "POST /opa/decision HTTP/1.1" 200 -
# 2024-05-29 23:08:29,282 - permitta.opa.decision_log_api - INFO - request: b'[{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"bb622a05-acff-480c-817a-8b2af96223b8","path":"permitta/trino/allow","input":{"action":{"operation":"ExecuteQuery"},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:08:23.262695294Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":396791,"timer_rego_query_eval_ns":1441625,"timer_server_handler_ns":2416042},"req_id":22}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"05609b91-60a5-4700-8f9f-6c69cbd4de5c","path":"permitta/trino/allow","input":{"action":{"operation":"AccessCatalog","resource":{"catalog":{"name":"system"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:08:23.280969002Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":43500,"timer_rego_query_eval_ns":103834,"timer_server_handler_ns":214167},"req_id":23}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"4a84a934-33d6-4678-bcda-d8a3f9007f64","path":"permitta/trino/allow","input":{"action":{"operation":"SelectFromColumns","resource":{"table":{"catalogName":"system","columns":["table_schem","table_catalog"],"schemaName":"jdbc","tableName":"schemas"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:08:23.283305127Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":28208,"timer_rego_query_eval_ns":70000,"timer_server_handler_ns":147333},"req_id":24}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"d8072173-76de-4a7c-8a37-214aa92db6fe","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:08:23.318277835Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":31292,"timer_rego_query_eval_ns":54375,"timer_server_handler_ns":122417},"req_id":25}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"2b6269c6-40b2-4f86-96be-39c75797157a","path":"permitta/trino/allow","input":{"action":{"operation":"FilterCatalogs","resource":{"catalog":{"name":"iceberg"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:08:23.38613196Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":23541,"timer_rego_query_eval_ns":46042,"timer_server_handler_ns":115334},"req_id":26}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"77fbd80e-55d2-4d33-8a0f-1e47c0507abd","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"information_schema"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55218","timestamp":"2024-05-29T13:08:23.387826002Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":17417,"timer_rego_query_eval_ns":47334,"timer_server_handler_ns":79959},"req_id":27}\n,{"labels":{"id":"337e33a2-7ee8-4dee-92d9-6db3b4294aba","version":"0.64.1"},"decision_id":"38d912ad-56af-42d0-a55e-379da857f41f","path":"permitta/trino/allow","input":{"action":{"operation":"FilterSchemas","resource":{"schema":{"catalogName":"iceberg","schemaName":"default"}}},"context":{"identity":{"groups":[],"user":"joel"},"softwareStack":{"trinoVersion":"448"}}},"result":true,"requested_by":"172.23.0.4:55230","timestamp":"2024-05-29T13:08:23.388474044Z","metrics":{"counter_server_query_cache_hit":1,"timer_rego_input_parse_ns":21792,"timer_rego_query_eval_ns":190958,"timer_server_handler_ns":241625},"req_id":28}\n]'
# 127.0.0.1 - - [29/May/2024 23:08:29] "POST /opa/decision HTTP/1.1" 200 -
